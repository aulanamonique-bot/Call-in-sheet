<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quote Calculator</title>
  <style>
    :root{      --green:#ff5aa5;
      --grid:#d0d7de;
      --soft-yellow:#ffe0f0;
      --soft-blue:#ffd1e6;
      --soft-blue-2:#ffe4f1;
      --soft-green:#ffe0ef;
      --bg:#ffffff;
      --text:#111;
    }
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 18px;
    }
    .sheet{ max-width: 1100px; margin: 0 auto; }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    h1{ font-size: 22px; margin: 0; font-weight: 800; letter-spacing: .3px; }
    .btnRow{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    button{
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-clear{ background:#ff2f92; color:#fff; }
    .btn-copy{ background:#ff7bbd; color:#fff; }

    .grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .section{ border: 1px solid var(--grid); border-radius: 10px; overflow: hidden; }
    .section .header{ background: var(--green); color: #fff; font-weight: 800; padding: 10px 12px; font-size: 15px; }
    .rows{ display: grid; grid-template-columns: 1.2fr 1fr; gap: 0; }
    .row{ display: contents; }
    .label{ padding: 10px 12px; border-top: 1px solid var(--grid); font-weight: 700; font-size: 14px; }
    .cell{ padding: 8px 10px; border-top: 1px solid var(--grid); border-left: 1px solid var(--grid); display:flex; align-items:center; }

    input[type="number"], input[type="text"], select{
      width: 100%;
      padding: 9px 10px;
      border: 1px solid var(--grid);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: white;
    }

    /* remove number spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .in-yellow input{ background: var(--soft-yellow); }
    .in-blue input, .in-blue select{ background: var(--soft-blue); }
    .in-blue2 input, .in-blue2 select{ background: var(--soft-blue-2); }

    .out-green{
      background: var(--soft-green);
      border-radius: 8px;
      padding: 9px 10px;
      width: 100%;
      border: 1px solid var(--grid);
      font-weight: 800;
      font-size: 16px;
    }
    .out-green.small{ font-size: 15px; }

    .full{ grid-column: 1 / -1; }
    .bundleTotals{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }

    details{ margin-top: 10px; border-top: 1px dashed var(--grid); padding-top: 10px; }
    details summary{ cursor:pointer; font-weight:800; }
    table{ width:100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    th, td{ border:1px solid var(--grid); padding:8px 10px; text-align:left; }
    th{ background:#f2f2f2; font-weight:800; }
    .right{ text-align:right; }
    .tierTag{ display:inline-block; padding: 3px 8px; border-radius: 999px; font-weight:800; font-size:12px; }
  
/* Customer Info (top) */
.customer-card{
  grid-column: 1 / -1;
  background: linear-gradient(180deg, rgba(255, 105, 180, .14), rgba(255,255,255,1));
  border: 1px solid rgba(255, 105, 180, .28);
  border-radius: 18px;
  overflow: hidden;
}
.customer-card .customer-head{
  padding: 18px 18px 6px;
}
.customer-card .customer-head h2{
  margin:0;
  font-size: 20px;
  font-weight: 900;
  letter-spacing: .2px;
}
.customer-card .customer-head p{
  margin: 6px 0 0;
  color: rgba(0,0,0,.62);
  font-weight: 700;
}

.customer-card .customer-body{
  padding: 14px 18px 18px;
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 14px 14px;
}
.customer-card .customer-body .field{ grid-column: span 6; }
.customer-card .customer-body .field.small{ grid-column: span 3; }
.customer-card .customer-body .field.full{ grid-column: 1 / -1; }
@media (max-width: 720px){
  .customer-card .customer-body{ grid-template-columns: 1fr; }
  .customer-card .customer-body .field,
  .customer-card .customer-body .field.small,
  .customer-card .customer-body .field.full{ grid-column: 1 / -1; }
}

.field label{
  display:block;
  font-weight: 900;
  margin-bottom: 8px;
}
.field input,.field select,.field textarea{
  width:100%;
  border-radius: 18px;
  border: 1px solid rgba(255, 105, 180, .32);
  padding: 14px 14px;
  font-size: 16px;
  outline: none;
  background: rgba(255,255,255,.78);
}
.field textarea{
  min-height: 110px;
  resize: vertical;
}
.field.full{grid-column: 1 / -1;}
.field input[readonly]{
  background: rgba(255,255,255,.55);
}


/* Compact sizing pass */
.customer-card .customer-head{padding:14px 14px 6px}
.customer-card .customer-head h2{font-size:18px}
.customer-card .customer-body{padding:12px 14px 14px; gap:12px}
.field label{margin-bottom:6px; font-size:12px}
.field input,.field select,.field textarea{
  padding:11px 12px;
  font-size:14px;
  border-radius:16px;
}
.field textarea{min-height:92px}


/* Horizontal Checklist */
.checklist-wrap{
  grid-column: 1 / -1;
  border: 1px dashed rgba(255, 105, 180, .38);
  background: rgba(255, 224, 240, .55);
  border-radius: 18px;
  padding: 12px 14px;
}
.checklist-title{
  font-weight: 900;
  margin: 0 0 10px 0;
  letter-spacing: .2px;
}
.checklist-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.chk{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border:1px solid rgba(255, 105, 180, .32);
  border-radius:999px;
  background: rgba(255,255,255,.78);
  font-weight:900;
  user-select:none;
}
.chk input{
  width:18px;
  height:18px;
  accent-color:#ff2f92;
  cursor:pointer;
}


/* Customer info layout (no overlap) */
.customer-card .customer-body{
  padding: 14px 18px 18px;
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 18px 18px;
}
.customer-card .customer-body .field{ grid-column: span 6; min-width:0; }
.customer-card .customer-body .field.quarter{ grid-column: span 3; min-width:0; }
.customer-card .customer-body .field.full{ grid-column: 1 / -1; min-width:0; }
.field label{
  display:block;
  font-weight: 900;
  margin-bottom: 10px;
}
.field input,.field select,.field textarea{
  width:100%;
  box-sizing:border-box;
  border-radius: 18px;
  border: 1px solid rgba(255, 105, 180, .32);
  padding: 14px 14px;
  font-size: 16px;
  outline: none;
  background: rgba(255,255,255,.78);
}
.field textarea{ min-height: 120px; resize: vertical; }
@media (max-width: 900px){
  .customer-card .customer-body{ grid-template-columns: 1fr; }
  .customer-card .customer-body .field,
  .customer-card .customer-body .field.quarter,
  .customer-card .customer-body .field.full{ grid-column: 1 / -1; }
}


    .btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; font-size:14px; cursor:pointer; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

  
    .steps{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 14px; }
    .step{ display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #f3b6d5; border-radius:999px; background:#fff; font-weight:800; font-size:13px; opacity:.85; }
    .step .num{ width:22px; height:22px; border-radius:999px; background:#ff2f92; color:#fff; display:inline-flex; align-items:center; justify-content:center; font-size:12px; }
    .step.active{ box-shadow: 0 0 0 3px rgba(255,47,146,.18); opacity:1; }
    .card{ border:1px solid #f3b6d5; border-radius:14px; background:#fff; padding:14px; }
    .cardTitle{ font-weight:900; font-size:14px; margin:0 0 10px 0; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }


    .suggestedBox{ font-size:13px !important; font-weight:700 !important; opacity:.75; }
    .dominantInput input{ font-size:18px !important; font-weight:900 !important; padding:12px 12px !important; }

</style>
</head>
<body>
  <div class="sheet">

<div class="steps">
  <div class="step active" id="step1Tag"><span class="num">1</span> Address</div>
  <div class="step" id="step2Tag"><span class="num">2</span> Auto-fill / Measure</div>
  <div class="step" id="step3Tag"><span class="num">3</span> Quote</div>
</div>

    <div class="topbar">
      <div class="brand">
        <h1>QUOTE CALCULATOR</h1>
      </div>
      <div class="btnRow">
        <button class="btn-clear" type="button" id="clearBtn">NEW LEAD (Clear)</button>
        <button class="btn-copy" type="button" id="copyBtn">Copy Quote Line</button>
      </div>
    </div>

    <div class="card" id="step3Card"><div class="cardTitle">Step 3 — Quote</div><div class="grid">
      
  
  
  <!-- Customer Info -->
  <section class="customer-card" id="customerInfo">
    <div class="customer-head">
      <h2>Customer info</h2>
    </div>

    <div class="customer-body">
      <div class="field quarter">
        <label>Date</label>
        <input id="custDate" type="date" placeholder="mm/dd/yyyy" />
      </div>

      <div class="field quarter">
        <label>Time</label>
        <input id="custTime" type="time" />
      </div>

      <div class="field" style="grid-column: span 6;">
        <label>Lead Source</label>
        <input id="custLeadSource" type="text" placeholder="Call / Web / Referral / Other" />
      </div>

      <div class="field">
        <label>Customer Name</label>
        <input id="custName" type="text" placeholder="First + Last" />
      </div>

      <div class="field">
        <label>Phone</label>
        <input id="custPhone" type="text" placeholder="(###) ###-####" />
      </div>

      <div class="field">
        <label>Email</label>
        <input id="custEmail" type="text" placeholder="name@email.com" />
      </div>

      <div class="field">
        <label>Preferred Contact</label>
        <select id="custPref">
          <option value="" selected></option>
          <option>Call</option>
          <option>Text</option>
          <option>Email</option>
        </select>
      </div>

      <div class="field full">
        <label>Service Address</label>
        <input id="custAddress" type="text" placeholder="Street, City, State, ZIP" />
      

</div></div><div class="card" id="step2Card"><div class="cardTitle">Step 2 — Auto-fill / Measure</div><div class="field" style="grid-column: 1 / -1;">
  <label>Auto-fill SqFt &amp; LF (GIS)</label>
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <select id="gisCounty" class="in" style="max-width:220px;">
      <option value="wake">Wake</option>
      <option value="durham">Durham</option>
    </select>
    <button type="button" class="btn btn-copy" id="gisLookup" style="white-space:nowrap;">Lookup from Address</button>
    <span id="gisStatus" style="font-size:12px; opacity:.85;"></span>
  </div>
  </div>

<div class="field" style="grid-column: 1 / -1;">
  <details>
    <summary><strong>Measure</strong></summary>
    
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <button type="button" class="btn btn-copy" id="mapMeasureBtn">Measure</button>
      <button type="button" class="btn btn-copy" id="mapClearShapeBtn" disabled>Clear</button>
      <button type="button" class="btn btn-copy" id="mapUseLfBtn" disabled>Submit LF</button>
      <span id="mapStatus" style="font-size:12px; opacity:.85;"></span>
    </div>
    
    <div id="mapWrap" style="margin-top:10px; border:1px solid #f3b6d5; border-radius:12px; overflow:hidden; display:none;">
      <div id="gmap" style="height:360px; width:100%;"></div>
    </div>
  </details>
</div></div>

</div>

      <div class="field quarter">
        <label>Pests / Concern</label>
        <input id="custPests" type="text" placeholder="Ants, roaches, mice, etc." />
      </div>

      <div class="field quarter">
        <label>Timing</label>
        <input id="custTiming" type="text" placeholder="ASAP / This week / Next month" />
      </div>

      <div class="field quarter">
        <label>Status</label>
        <select id="custStatus">
          <option value="" selected></option>
          <option>Booked</option>
          <option>Pending</option>
          <option>Declined</option>
          <option>Sold QT</option>
          <option>Sold Bundle</option>
          <option>Sold Other</option>
        </select>
      </div>

      <div class="field quarter">
        <label>Appt Date/Time</label>
        <input id="custAppt" type="text" placeholder="MM/DD @ 2pm" />
      </div>

      <div class="field full">
        <label>Notes</label>
        <textarea id="custNotes" placeholder="Objections, pets, gate code, special instructions..."></textarea>
      </div>

      <!-- Keep quoted price for calculator to write into -->
      <input id="custQuote" type="hidden" value="" />
      <input id="custSource" type="hidden" value="" />
      <input id="custReason" type="hidden" value="" />
    </div>
  </section>




  <!-- Checklist -->
  <section class="checklist-wrap" id="checklist">
    <div class="checklist-title">Checklist</div>
    <div class="checklist-row" aria-label="Horizontal checklist">
      <label class="chk"><input id="chkINT" type="checkbox" /> INT</label>
      <label class="chk"><input id="chkPS" type="checkbox" /> PS</label>
      <label class="chk"><input id="chkWD" type="checkbox" /> WD</label>
      <label class="chk"><input id="chkGR" type="checkbox" /> GR</label>
      <label class="chk"><input id="chkLB" type="checkbox" /> LB</label>
      <label class="chk"><input id="chkRS" type="checkbox" /> RS</label>
    </div>
  </section>


<!-- QT Square Footage -->
      <div class="section">
        <div class="header">QT Square Footage</div>
        <div class="rows">
          <div class="row">
            <div class="label">SqFt</div>
            <div class="cell in-blue2">
              <input id="sqft" type="number" min="0" step="1" placeholder="" />
            </div>
          </div>
        </div>

        <details>
          <summary>Show pricing tiers</summary>
          <table>
            <thead>
              <tr><th>SqFt Range</th><th class="right">QT</th></tr>
            </thead>
            <tbody id="tiersTable"></tbody>
          </table>
        </details>
      </div>

      <!-- Termite Linear Feet --><div id="termiteLfWrap" style="display:none;">
      <div class="section">
        <div class="header">Termite Linear Feet</div>
        <div class="rows">
          <div class="row">
            <div class="label">Linear ft</div>
            <div class="cell in-blue2">
              <input id="lf" type="number" min="0" step="1" placeholder="" />
            </div>
          </div>
        </div>
      </div>

      </div>

      <!-- Bundle + Discounts -->
      <div class="section full">
        <div class="header">Bundle + Discounts</div>
        <div class="rows">
          <div class="row">
            <div class="label">Termite Protection</div>
            <div class="cell in-blue2">
              <button type="button" class="btn btn-copy" id="toggleTermiteBtn" style="width:100%;">Add Termite Protection</button>
            </div>
          </div>
          <input type="hidden" id="includeTermite" value="No" />
          
          <div class="row">
            <div class="label">YIF Discount</div>
            <div class="cell in-blue2" style="gap:10px;">
              <label style="display:flex; gap:8px; align-items:center; font-weight:800; font-size:13px;">
                <input type="checkbox" id="yifPestChk" /> Pest
              </label>
              <label style="display:flex; gap:8px; align-items:center; font-weight:800; font-size:13px;">
                <input type="checkbox" id="yifTermChk" /> Termite
              </label>
              <div id="yifPctWrap" style="display:none; flex:1; min-width:160px;">
                <input id="yifDisc" type="text" value="5" aria-label="YIF discount percent" />
              </div>
            </div>
          </div>
    
      </div>

      <!-- QT Rate -->
      <div class="section">
        <div class="header">QT Rate</div>
        <div class="rows">
          <div class="row">
            <div class="label">Suggested QT rate</div>
            <div class="cell in-yellow"><div class="out-green small suggestedBox" id="pestSuggested">$0.00</div></div>
          </div>
          <div class="row">
            <div class="label">Your quote QT Rate</div>
            <div class="cell in-blue dominantInput">
              <input id="pestQuote" type="number" min="0" step="0.01" placeholder="Negotiable" />
            </div>
          </div>
          <div class="row">
            <div class="label">Initial service fee</div>
            <div class="cell in-blue">
              <input id="pestInit" type="number" min="0" step="0.01" value="399" />
            </div>
          </div>
          <div class="row">
            <div class="label">Pest Monthly</div>
            <div class="cell"><div class="out-green" id="pestMonthly">$0</div></div>
          </div>
          <div class="row">
            <div class="label">Pest YIF</div>
            <div class="cell"><div class="out-green" id="pestYIF">$0.00</div></div>
          </div>
        </div>
      </div>

      <!-- Termite Yearly Rate --><div id="termiteSectionWrap" style="display:none;">
      <div class="section">
        <div class="header">Termite Yearly Rate</div>
        <div class="rows">
          <div class="row">
            <div class="label">Suggested SM Rate</div>
            <div class="cell in-yellow"><div class="out-green small suggestedBox" id="termSuggested">$0.00</div></div>
          </div>
          <div class="row">
            <div class="label">Your quote SM Rate</div>
            <div class="cell in-blue dominantInput">
              <input id="termQuote" type="number" min="0" step="0.01" placeholder="Negotiable" />
            </div>
          </div>
          <div class="row">
            <div class="label">Termite install fee</div>
            <div class="cell in-blue">
              <input id="termInstall" type="number" min="0" step="0.01" value="0" />
            </div>
          </div>
          <div class="row">
            <div class="label">SM Monthly</div>
            <div class="cell"><div class="out-green" id="termMonthly">$0</div></div>
          </div>
          <div class="row">
            <div class="label">Termite YIF</div>
            <div class="cell"><div class="out-green" id="termYIF">$0.00</div></div>
          </div>
        </div>
      </div>

      </div>

      <div id="bundleTotalsWrap" style="display:none;">
      <!-- Bundle Totals -->
      <div class="section full">
        <div class="header">Bundle Totals</div>
        <div class="bundleTotals" style="padding:12px;">
          <div>
            <div class="label" style="border:0; padding:0 0 8px 0;">Bundle QT Rate</div>
            <div class="out-green" id="bundleQT">$0.00</div>
          </div>
          <div>
            <div class="label" style="border:0; padding:0 0 8px 0;">Bundle YIF (Pest + Termite)</div>
            <div class="out-green" id="bundleYIF">$0.00</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
  const tiers = [
    {min:1000, max:1499, qt:139},
    {min:1500, max:2499, qt:159},
    {min:2500, max:3499, qt:179},
    {min:3500, max:3999, qt:199},
    {min:4000, max:4499, qt:209},
    {min:4500, max:5000, qt:219},
  ];

  const qtColors = {"219": "#ffb3d1", "209": "#ffc2dc", "199": "#ffd1e6", "179": "#ffe0f0", "169": "#ffd6ea", "159": "#ffcade", "149": "#ffbed4", "139": "#ffb3d1", "129": "#ffa3c8"};

  const $ = (id) => document.getElementById(id);

  function money(n){
    const x = Number.isFinite(n) ? n : 0;
    return x.toLocaleString(undefined, {style:'currency', currency:'USD'});
  }
  function money0(n){
    const x = Number.isFinite(n) ? n : 0;
    return x.toLocaleString(undefined, {style:'currency', currency:'USD', maximumFractionDigits:0});
  }
  function ceil(n){ return Math.ceil(n); }

  function suggestedPestQT(sqft){
    if(!Number.isFinite(sqft) || sqft<=0) return 0;
    let best = 0;
    for(const t of tiers){ if(sqft >= t.min) best = t.qt; }
    return best;
  }

  function yifDiscount(){
    const raw = String($('yifDisc').value || '').replace('%','').trim();
    const pct = parseFloat(raw);
    return Number.isFinite(pct) ? (pct/100) : 0;
  }
  function bundleDiscount(){
    const raw = String($('bundleDisc').value || '').replace('$','').trim();
    const n = parseFloat(raw);
    return Number.isFinite(n) ? n : 0;
  }
  
  function yifApplyPest(){ return document.getElementById('yifPestChk')?.checked === true; }
  function yifApplyTermite(){ return document.getElementById('yifTermChk')?.checked === true; }


  function calc(){
    const sqft = parseFloat($('sqft').value);
    const lf = parseFloat($('lf').value);
    const include = $('includeTermite').value === 'Yes';

    const yifDisc = yifDiscount(); // 0.05 default
    const bundleDisc = bundleDiscount(); // 10 default
    const mode = payInFullMode(); // None/Pest/Termite/Both

    // Pest
    const pestSuggested = suggestedPestQT(sqft);
    $('pestSuggested').textContent = money(pestSuggested);

    const pestQuote = parseFloat($('pestQuote').value);
    const pestInit = parseFloat($('pestInit').value);
    const pestFinal = Number.isFinite(pestQuote) ? pestQuote : pestSuggested;
    const pestAfterBundle = include ? Math.max(0, pestFinal - bundleDisc) : pestFinal;

    // Default initial fee to match QT rate unless manually changed
    if(!pestInitTouched && pestAfterBundle>0){
      const pi = document.getElementById('pestInit');
      if(pi) pi.value = String(pestAfterBundle.toFixed(2));
    }


    const pestMonthly = (pestAfterBundle>0) ? ceil(pestAfterBundle/3) : 0;

    const pestYearBase = pestAfterBundle * 4;
    const pestInitSafe = (Number.isFinite(pestInit)?pestInit:0);
    const pestTotalBase = pestYearBase + pestInitSafe;
    const pestYIF = (pestAfterBundle>0)
      ? (yifApplyPest() ? (pestTotalBase * (1 - yifDisc)) : pestTotalBase)
      : 0;

    $('pestMonthly').textContent = money0(pestMonthly);
    $('pestYIF').textContent = money(pestYIF);

    // Termite (yearly = lf * 1.5 unless quote override)
    const termSuggested = (Number.isFinite(lf) && lf>0) ? (lf * 1.5) : 0;
    $('termSuggested').textContent = money(termSuggested);

    const termQuote = parseFloat($('termQuote').value);
    const termInstall = parseFloat($('termInstall').value);
    const termFinal = Number.isFinite(termQuote) ? termQuote : termSuggested;

    const termMonthly = (termFinal>0) ? ceil(termFinal/12) : 0;
    const termInstallSafe = (Number.isFinite(termInstall)?termInstall:0);
    const termTotalBase = termFinal + termInstallSafe;
    const termYIF = (termFinal>0)
      ? (yifApplyTermite() ? (termTotalBase * (1 - yifDisc)) : termTotalBase)
      : 0;

    $('termMonthly').textContent = money0(termMonthly);
    $('termYIF').textContent = money(termYIF);

    // Bundle totals
    $('bundleQT').textContent = money(pestAfterBundle);
    $('bundleYIF').textContent = money(include ? (pestYIF + termYIF) : pestYIF);

    // Copy line
    const quoteLine = include
      ? `Pest QT ${money(pestAfterBundle)} (Monthly ${money0(pestMonthly)}), Termite YR ${money(termFinal)} (Monthly ${money0(termMonthly)}), Bundle YIF ${money(pestYIF + termYIF)}`
      : `Pest QT ${money(pestAfterBundle)} (Monthly ${money0(pestMonthly)}), Pest YIF ${money(pestYIF)}`;
    $('copyBtn').dataset.quote = quoteLine;
  }

  function clearAll(){
    // Calculator inputs
    $('sqft').value = '';
    $('lf').value = '';
    $('includeTermite').value = 'No';
    
    $('yifDisc').value = '5';
    const yp=document.getElementById('yifPestChk'); if(yp) yp.checked=false;
    const yt=document.getElementById('yifTermChk'); if(yt) yt.checked=false;
    if(typeof syncYifUi==='function') syncYifUi();
    $('bundleDisc').value = '10';
    $('pestQuote').value = '';
    $('pestInit').value = '399';
    $('termQuote').value = '';
    $('termInstall').value = '0';

    // Customer info (everything)
    [
      'custDate','custTime','custLeadSource','custName','custPhone','custEmail',
      'custPref','custAddress','custPests','custTiming','custStatus','custAppt','custNotes'
    ].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(el.tagName === 'SELECT'){ el.value = ''; }
      else { el.value = ''; }
    });

    // Checklist
    ['chkINT','chkPS','chkWD','chkGR','chkLB','chkRS'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.checked = false;
    });

    calc();
  }

  function copyQuote(){
    const text = $('copyBtn').dataset.quote || '';
    if(!text) return;
    navigator.clipboard.writeText(text).then(()=>{
      const btn = $('copyBtn');
      const old = btn.textContent;
      btn.textContent = 'Copied';
      setTimeout(()=>btn.textContent = old, 900);
    }).catch(()=>{ alert('Copy failed. You can select and copy manually.'); });
  }

  // Populate tiers table with palette colors
  const tbody = document.getElementById('tiersTable');
  tiers.forEach(t=>{
    const tr = document.createElement('tr');
    const bg = qtColors[t.qt] || '#ffffff';
    tr.innerHTML = `<td><span class="tierTag" style="background:${bg}">${t.min.toLocaleString()}–${t.max.toLocaleString()}</span></td>
                    <td class="right" style="background:${bg}; font-weight:800;">${money(t.qt)}</td>`;
    tbody.appendChild(tr);
  });

  // Wire up events (safe bind — avoids null addEventListener)
  ['sqft','lf','includeTermite','yifDisc','bundleDisc','pestQuote','pestInit','termQuote','termInstall']
    .forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('input', calc);
      el.addEventListener('change', calc);
    });
  const clearBtn = document.getElementById('clearBtn');
  if(clearBtn) clearBtn.addEventListener('click', clearAll);
  const copyBtn = document.getElementById('copyBtn');
  if(copyBtn) copyBtn.addEventListener('click', copyQuote);
// Initial
  calc();



  // ------------------------
  // GIS AUTO-FILL (Wake / Durham)
  // ------------------------
  async function gisLookup(){
    const status = document.getElementById('gisStatus');
    const county = document.getElementById('gisCounty')?.value || 'wake';
    const addr = (document.getElementById('custAddress')?.value || '').trim();

    status.textContent = '';
    if(!addr){
      status.textContent = 'Enter an address first.';
      return;
    }

    const setStatus = (t)=>{ status.textContent = t; };

    // Normalize for LIKE queries
    const norm = addr.replace(/[,#]/g,' ').replace(/\s+/g,' ').trim().toUpperCase();

    try{
      setStatus('');

      if(county === 'wake'){
        // Wake parcels: HEATEDAREA + SITE_ADDRESS
        // Service: https://maps.wakegov.com/arcgis/rest/services/Property/Parcels/FeatureServer/0  (fields include HEATEDAREA, SITE_ADDRESS)
        const base = 'https://maps.wakegov.com/arcgis/rest/services/Property/Parcels/FeatureServer/0/query';
        const where = "UPPER(SITE_ADDRESS) LIKE '%" + norm.replace(/'/g,"''") + "%'";
        const url = base + '?' + new URLSearchParams({
          f:'json',
          where,
          outFields:'HEATEDAREA,SITE_ADDRESS',
          returnGeometry:'false',
          resultRecordCount:'1'
        }).toString();

        const r = await fetch(url);
        const j = await r.json();
        const feat = j?.features?.[0];
        const sqft = feat?.attributes?.HEATEDAREA;

        if(!feat){
          setStatus('Not found');
          return;
        }
        if(Number.isFinite(sqft)){
          document.getElementById('sqft').value = String(Math.round(sqft));
          setStatus('');
          calc();
        }else{
          setStatus('Not found');
        }
        return;
      }

      if(county === 'durham'){
        // Durham parcels: HEATED_AREA + LOCATION_ADDR; we also try to estimate LF using city building footprints layer (within city limits)
        // Parcels layer: https://webgis.durhamnc.gov/server/rest/services/PublicServices/Property/MapServer/4
        // Buildings layer (city limits): https://webgis2.durhamnc.gov/server/rest/services/PublicWorksServices/OnlineCheckerV2/MapServer/17
        const parcelsBase = 'https://webgis.durhamnc.gov/server/rest/services/PublicServices/Property/MapServer/4/query';
        const where = "UPPER(LOCATION_ADDR) LIKE '%" + norm.replace(/'/g,"''") + "%'";
        const parcelUrl = parcelsBase + '?' + new URLSearchParams({
          f:'json',
          where,
          outFields:'HEATED_AREA,LOCATION_ADDR',
          returnGeometry:'true',
          outSR:'2264', // state plane feet (matches services)
          resultRecordCount:'1'
        }).toString();

        const pr = await fetch(parcelUrl);
        const pj = await pr.json();
        const pFeat = pj?.features?.[0];
        const sqft = pFeat?.attributes?.HEATED_AREA;

        if(!pFeat){
          setStatus('Not found');
          return;
        }

        if(Number.isFinite(sqft)){
          document.getElementById('sqft').value = String(Math.round(sqft));
        }

        // Try to estimate LF from building footprints intersecting the parcel polygon:
        // We'll query for max SHAPE.STLength() in the building layer using outStatistics.
        const geom = pFeat?.geometry;
        if(!geom){
          setStatus('');
          calc();
          return;
        }

        setStatus('');

        const bBase = 'https://webgis2.durhamnc.gov/server/rest/services/PublicWorksServices/OnlineCheckerV2/MapServer/17/query';
        const outStatistics = JSON.stringify([{
          statisticType:'max',
          onStatisticField:'Shape.STLength()',
          outStatisticFieldName:'max_len'
        }]);

        const bUrl = bBase + '?' + new URLSearchParams({
          f:'json',
          geometry: JSON.stringify(geom),
          geometryType:'esriGeometryPolygon',
          inSR:'2264',
          spatialRel:'esriSpatialRelIntersects',
          outFields:'',
          outStatistics,
          returnGeometry:'false'
        }).toString();

        const br = await fetch(bUrl);
        const bj = await br.json();
        const maxLen = bj?.features?.[0]?.attributes?.max_len;

        if(Number.isFinite(maxLen) && maxLen > 0){
          // maxLen is in feet (StatePlane feet). Round to nearest whole.
          document.getElementById('lf').value = String(Math.round(maxLen));
          setStatus('');
        }else{
          setStatus('');
        }

        calc();
        return;
      }

    }catch(err){
      console.error(err);
      setStatus('Blocked by browser/CORS. If you want this to work as a shared link, we’ll need a tiny proxy (Cloudflare/Netlify).');
    }
  }

  document.getElementById('gisLookup')?.addEventListener('click', gisLookup);



  // ------------------------
  // GOOGLE MAPS: DRAW + PERIMETER → LF
  // ------------------------
  // Put your API key here:
  const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';

  let gmap, geocoder, drawingManager, activeShape, lastPerimeterFeet = 0;

  function setMapStatus(t){ const el = document.getElementById('mapStatus'); if(el) el.textContent = t; }

  function enableMapControls(loaded){
    const ids = ['mapClearShapeBtn','mapUseLfBtn'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.disabled = !loaded;
    });
  }

  function loadGoogleMapsScript(){
    return new Promise((resolve, reject)=>{
      if(window.google && window.google.maps){ resolve(); return; }
      if(!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY.includes('YOUR_')){
        reject(new Error('Missing API key'));
        return;
      }
      const s = document.createElement('script');
      // Load drawing + geometry + places (for autocomplete if you want later)
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=drawing,geometry,places`;
      s.async = true;
      s.defer = true;
      s.onload = ()=>resolve();
      s.onerror = ()=>reject(new Error('Failed to load Google Maps'));
      document.head.appendChild(s);
    });
  }

  function computePerimeterFeetFromPolygon(polygon){
    const path = polygon.getPath();
    if(!path || path.getLength() < 2) return 0;
    const pts = [];
    for(let i=0;i<path.getLength();i++) pts.push(path.getAt(i));
    // Close the loop
    pts.push(path.getAt(0));
    const meters = google.maps.geometry.spherical.computeLength(pts);
    const feet = meters * 3.280839895;
    return feet;
  }

  function clearActiveShape(){
    if(activeShape){ activeShape.setMap(null); activeShape = null; }
    lastPerimeterFeet = 0;
    setMapStatus('');
  }

  async function initMap(){
    setMapStatus('');
    await loadGoogleMapsScript();

    document.getElementById('mapWrap').style.display = 'block';

    gmap = new google.maps.Map(document.getElementById('gmap'), {
      center: { lat: 35.7796, lng: -78.6382 }, // Raleigh-ish default
      zoom: 12,
      mapTypeId: 'hybrid'
    });

    geocoder = new google.maps.Geocoder();
    
    // Places Autocomplete for address (WAY better than raw geocoding)
    try{
      const addrEl = document.getElementById('custAddress');
      if(addrEl && google.maps.places){
        const ncBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(33.5, -84.5),  // SW-ish (covers NC comfortably)
          new google.maps.LatLng(37.0, -75.0)   // NE-ish
        );
        window.__selectedPlace = null;
        window.__addrAutocomplete = new google.maps.places.Autocomplete(addrEl, {
          fields: ['geometry','place_id','formatted_address','name'],
          componentRestrictions: { country: 'us' },
          bounds: ncBounds,
          strictBounds: false
        });
        window.__addrAutocomplete.addListener('place_changed', ()=>{
          const p = window.__addrAutocomplete.getPlace();
          if(p && p.geometry && p.geometry.location){
            window.__selectedPlace = p;
            // If Google provides a nicer formatted address, keep it for your records
            if(p.formatted_address) addrEl.value = p.formatted_address;
          }
        });
      }
    }catch(e){
      console.warn('Autocomplete init failed', e);
    }


    drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: null,
      drawingControl: false,
      polygonOptions: {
        fillColor: '#ff5aa5',
        fillOpacity: 0.22,
        strokeColor: '#ff2f92',
        strokeOpacity: 0.9,
        strokeWeight: 2,
        clickable: true,
        editable: true,
        zIndex: 3
      }
    });
    drawingManager.setMap(gmap);

    google.maps.event.addListener(drawingManager, 'overlaycomplete', function(e) {
      // Only one shape at a time
      clearActiveShape();
      drawingManager.setDrawingMode(null);
      activeShape = e.overlay;

      const update = ()=>{
        lastPerimeterFeet = computePerimeterFeetFromPolygon(activeShape);
        setMapStatus(`Perimeter: ${Math.round(lastPerimeterFeet).toLocaleString()} ft`);
        const useBtn = document.getElementById('mapUseLfBtn');
        if(useBtn) useBtn.disabled = !(lastPerimeterFeet > 0);
      };

      update();
      // update on edits
      google.maps.event.addListener(activeShape.getPath(), 'set_at', update);
      google.maps.event.addListener(activeShape.getPath(), 'insert_at', update);
      google.maps.event.addListener(activeShape.getPath(), 'remove_at', update);
    });

    enableMapControls(true);
    setMapStatus('');
  }

  function goToAddressOnMap(){
    if(!gmap) return;

    // 1) If user selected an Autocomplete suggestion, use it (best)
    const sp = window.__selectedPlace;
    if(sp && sp.geometry && sp.geometry.location){
      const loc = sp.geometry.location;
      gmap.setCenter(loc);
      gmap.setZoom(20);
      setMapStatus('');
      return;
    }

    // 2) Fall back to Geocoder (still works, just pickier)
    if(!geocoder) geocoder = new google.maps.Geocoder();
    const addr = (document.getElementById('custAddress')?.value || '').trim();
    if(!addr){ setMapStatus('Not found'); return; }

    const ncBounds = new google.maps.LatLngBounds(
      new google.maps.LatLng(33.5, -84.5),
      new google.maps.LatLng(37.0, -75.0)
    );

    geocoder.geocode({
      address: addr,
      bounds: ncBounds,
      region: 'us',
      componentRestrictions: { country: 'US' }
    }, (results, status)=>{
      if(status === 'OK' && results && results[0]){
        const loc = results[0].geometry.location;
        gmap.setCenter(loc);
        gmap.setZoom(20);
        setMapStatus('');
      } else {
        setMapStatus('Not found');
      }
    });
  }

  function startDrawPerimeter(){
    if(!drawingManager) return;
    setMapStatus('');
    drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
  }

  function usePerimeterAsLF(){
    if(!(lastPerimeterFeet > 0)) return;
    const lfInput = document.getElementById('lf');
    lfInput.value = String(Math.round(lastPerimeterFeet));
    setMapStatus('');
    calc();
  }

  // Wire up map buttons
  document.getElementById('mapMeasureBtn')?.addEventListener('click', async ()=>{
    try{
      await initMap();
      // one-click: find address then start drawing
      setTimeout(()=>{ goToAddressOnMap(); setTimeout(()=>startDrawPerimeter(), 600); }, 250);
      document.getElementById('mapClearShapeBtn').disabled = false;
      document.getElementById('mapUseLfBtn').disabled = true;
    }catch(e){
      console.error(e);
      setMapStatus(e.message === 'Missing API key'
        ? 'Add your Google Maps API key in the file (GOOGLE_MAPS_API_KEY).'
        : 'Could not load Google Maps (check key, billing, and restrictions).');
    }
  });
  document.getElementById('mapClearShapeBtn')?.addEventListener('click', clearActiveShape);
  document.getElementById('mapUseLfBtn')?.addEventListener('click', usePerimeterAsLF);



  // Step highlighting
  function setActiveStep(n){
    ['step1Tag','step2Tag','step3Tag'].forEach((id,i)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle('active', (i+1)===n);
    });
  }
  ['custAddress','gisLookup','mapLoadBtn','sqft','lf','pestQuote','termQuote'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('focus', ()=>{
      if(id==='custAddress') setActiveStep(1);
      else if(['gisLookup','mapLoadBtn'].includes(id)) setActiveStep(2);
      else setActiveStep(3);
    });
  });


  // Keep Initial Service Fee starting at the QT rate unless user edits it
  let pestInitTouched = false;
  const pestInitEl = document.getElementById('pestInit');
  if(pestInitEl){
    pestInitEl.addEventListener('input', ()=>{ pestInitTouched = true; });
  }


  // Show/hide YIF % input only if a discount checkbox is checked
  function syncYifUi(){
    const show = (document.getElementById('yifPestChk')?.checked || document.getElementById('yifTermChk')?.checked);
    const wrap = document.getElementById('yifPctWrap');
    if(wrap) wrap.style.display = show ? 'block' : 'none';
  }
  document.getElementById('yifPestChk')?.addEventListener('change', ()=>{ syncYifUi(); calc(); });
  document.getElementById('yifTermChk')?.addEventListener('change', ()=>{ syncYifUi(); calc(); });
  syncYifUi();


  // Termite toggle
  let termiteEnabled = false;
  function syncTermiteUi(){
    const btn = document.getElementById('toggleTermiteBtn');
    const wrap = document.getElementById('termiteSectionWrap');
    const lfWrap = document.getElementById('termiteLfWrap');
    const bundleWrap = document.getElementById('bundleTotalsWrap');
    if(btn) btn.textContent = termiteEnabled ? 'Remove Termite Protection' : 'Add Termite Protection';
    if(wrap) wrap.style.display = termiteEnabled ? 'block' : 'none';
    if(lfWrap) lfWrap.style.display = termiteEnabled ? 'block' : 'none';
    if(bundleWrap) bundleWrap.style.display = termiteEnabled ? 'block' : 'none';

    const include = document.getElementById('includeTermite');
    if(include) include.value = termiteEnabled ? 'Yes' : 'No';

    if(!termiteEnabled){
      const lf = document.getElementById('lf'); if(lf) lf.value='';
      const tq = document.getElementById('termQuote'); if(tq) tq.value='';
      const ti = document.getElementById('termInstall'); if(ti) ti.value='0';
      const yt = document.getElementById('yifTermChk'); if(yt) yt.checked=false;
      if(typeof syncYifUi==='function') syncYifUi();
    }
    calc();
  }
  document.getElementById('toggleTermiteBtn')?.addEventListener('click', ()=>{
    termiteEnabled = !termiteEnabled;
    syncTermiteUi();
  });
  syncTermiteUi();

</script>
</body>
</html>
